<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard - DailyBasisRoute</title>
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/style.css') }}"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
  </head>
  <body>
    <nav class="navbar">
      <div class="nav-container">
        <h1>DailyBasisRoute</h1>
        <div class="nav-links">
          <a href="/dashboard" class="active">Dashboard</a>
          <a href="/analytics">Analytics</a>
          <a href="/historico">History</a>
          <a href="/logout">Logout</a>
        </div>
      </div>
    </nav>

    <div class="container">
      <div class="welcome-header">
        <h2>Hello, {{ session.user_name }}!</h2>
        <p>{{ today }}</p>
      </div>

      <!-- Stats Cards -->
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-number" id="totalPoints">0</div>
          <div class="stat-label">Points Today</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="maxPoints">100</div>
          <div class="stat-label">Maximum Points</div>
        </div>
        <div class="stat-card">
          <div class="stat-number">{{ streak }}</div>
          <div class="stat-label">Day Streak üî•</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="weekProgress">0%</div>
          <div class="stat-label">Weekly Progress</div>
        </div>
      </div>

      <!-- Progress Bar -->
      <div class="progress-bar">
        <div class="progress-fill" id="progressFill" style="width: 0%">
          <span id="progressText">0/100 pts</span>
        </div>
      </div>

      <!-- Fixed Pillars -->
      <div class="tasks-container">
        <div class="section-title">
          <span><i class="fas fa-bolt section-icon"></i> Fixed Pillars</span>
          <span class="section-points">50 points base</span>
        </div>
        <div id="pillarsTasks">
          {% for task in tasks.pillars %}
          <div
            class="task-item {% if task.completed %}completed{% endif %}"
            data-task-id="{{ task.id }}"
            data-points="{{ task.points }}"
          >
            <div class="checkbox"></div>
            <div class="task-info">
              <div class="task-name">
                <i class="fas fa-{{ task.emoji }} task-icon"></i>
                {{ task.name }}
              </div>
              <div class="task-details">{{ task.details }}</div>
            </div>
            <div class="task-points">+{{ task.points }}</div>
          </div>
          {% endfor %}
        </div>
      </div>

      <!-- Tasks -->
      <div class="tasks-container">
        <div class="section-title">
          <span><i class="fas fa-tasks section-icon"></i> Tasks</span>
          <span class="section-points">Choose up to 60 points</span>
        </div>
        <div id="dailyTasks">
          {% for task in tasks.tasks %}
          <div
            class="task-item {% if task.completed %}completed{% endif %}"
            data-task-id="{{ task.id }}"
            data-points="{{ task.points }}"
          >
            <div class="checkbox"></div>
            <div class="task-info">
              <div class="task-name">
                <i class="fas fa-{{ task.emoji }} task-icon"></i>
                {{ task.name }}
              </div>
              <div class="task-details">{{ task.details }}</div>
            </div>
            <div class="task-points">+{{ task.points }}</div>
          </div>
          {% endfor %}
        </div>
      </div>

      <!-- Bonus Points -->
      <div class="tasks-container">
        <div class="section-title">
          <span><i class="fas fa-star section-icon"></i> Bonus Points</span>
          <span class="section-points">Extra achievements</span>
        </div>
        <div id="bonusTasks">
          {% for task in tasks.bonus %}
          <div
            class="task-item {% if task.completed %}completed{% endif %}"
            data-task-id="{{ task.id }}"
            data-points="{{ task.points }}"
          >
            <div class="checkbox"></div>
            <div class="task-info">
              <div class="task-name">
                <i class="fas fa-{{ task.emoji }} task-icon"></i>
                {{ task.name }}
              </div>
              <div class="task-details">{{ task.details }}</div>
            </div>
            <div class="task-points">+{{ task.points }}</div>
          </div>
          {% endfor %}
        </div>
      </div>

      <!-- Custom Tasks -->
      <div class="tasks-container">
        <div class="section-title">
          <span
            ><i class="fas fa-plus-circle section-icon"></i> Custom Tasks</span
          >
          <button class="btn-add-task" onclick="openCustomTaskModal()">
            + Add Task
          </button>
        </div>
        <div id="customTasksContainer">
          {% if custom_tasks %} {% for task in custom_tasks %}
          <div class="custom-task-item" data-custom-id="{{ task.id }}">
            <div class="task-info">
              <div class="task-name">{{ task.name }}</div>
            </div>
            <div class="task-points">+{{ task.points }}</div>
            <button
              class="btn-delete-task"
              onclick="deleteCustomTask({{ task.id }})"
            >
              √ó
            </button>
          </div>
          {% endfor %} {% else %}
          <div class="empty-task-state">
            No custom tasks yet. Click "+ Add Task" to create one!
          </div>
          {% endif %}
        </div>
      </div>

      <!-- Mood Tracker -->
      <div class="tasks-container mood-tracker">
        <div class="section-title">
          <span><i class="fas fa-smile section-icon"></i> Mood Tracker</span>
          <span class="mood-value" id="moodValue">{{ mood }}</span>
        </div>
        <div class="mood-slider-container">
          <input
            type="range"
            min="0"
            max="100"
            value="{{ mood }}"
            class="mood-slider"
            id="moodSlider"
          />
          <div class="mood-labels">
            <span>üò¢ Low</span>
            <span>üòê Neutral</span>
            <span>üòä Great</span>
          </div>
          <div class="mood-description" id="moodDescription">Neutral</div>
        </div>
      </div>

      <!-- Daily Report (4 Questions) -->
      <div class="tasks-container">
        <div class="section-title">
          <span
            ><i class="fas fa-clipboard-list section-icon"></i> Daily
            Report</span
          >
        </div>
        <div style="display: flex; flex-direction: column; gap: 20px">
          <div class="form-group">
            <label for="workPerformance"
              ><strong>1. Work Performance (1-10)</strong></label
            >
            <input
              type="number"
              id="workPerformance"
              min="1"
              max="10"
              placeholder="Rate 1-10"
              style="
                width: 100%;
                padding: 12px;
                border: 2px solid #e9ecef;
                border-radius: 8px;
                font-size: 1em;
              "
            />
          </div>
          <div class="form-group">
            <label for="accomplishment"
              ><strong>2. Main Accomplishment Today</strong></label
            >
            <textarea
              id="accomplishment"
              placeholder="What did you accomplish?"
              class="daily-note"
              style="min-height: 80px"
            ></textarea>
          </div>
          <div class="form-group">
            <label for="challenge"
              ><strong>3. Main Challenge Faced</strong></label
            >
            <textarea
              id="challenge"
              placeholder="What was difficult?"
              class="daily-note"
              style="min-height: 80px"
            ></textarea>
          </div>
          <div class="form-group">
            <label for="randomThought"
              ><strong>4. Random Thought/Reflection</strong></label
            >
            <textarea
              id="randomThought"
              placeholder="Any other thoughts?"
              class="daily-note"
              style="min-height: 80px"
            ></textarea>
          </div>
          <button class="btn-save" onclick="saveDailyReport()">
            Save Daily Report
          </button>
        </div>
      </div>

      <!-- Export Section -->
      <div class="tasks-container">
        <div class="export-section">
          <h3>Export Data</h3>
          <div class="export-buttons">
            <button class="btn-export" onclick="exportData('week')">
              Last 7 Days
            </button>
            <button class="btn-export" onclick="exportData('biweekly')">
              Last 14 Days
            </button>
            <button class="btn-export" onclick="exportData('month')">
              Last 30 Days
            </button>
            <button class="btn-export" onclick="exportData('all')">
              All Data
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Custom Task Modal -->
    <div id="customTaskModal" class="modal">
      <div class="modal-content">
        <span class="close" onclick="closeCustomTaskModal()">&times;</span>
        <h2>Add Custom Task</h2>
        <p class="modal-subtitle">Completed something extra? Track it here!</p>
        <div class="form-group">
          <label>Task Name</label>
          <input
            type="text"
            id="customTaskName"
            placeholder="E.g., Fixed a critical bug"
          />
        </div>
        <div class="form-group">
          <label>Points</label>
          <div class="points-selector">
            <button class="point-btn" onclick="selectPoints(5)">5</button>
            <button class="point-btn" onclick="selectPoints(10)">10</button>
            <button class="point-btn" onclick="selectPoints(15)">15</button>
            <button class="point-btn" onclick="selectPoints(20)">20</button>
          </div>
        </div>
        <button class="btn-primary" onclick="addCustomTask()">Add Task</button>
      </div>
    </div>

    <script>
      let selectedPoints = 10;

      function updatePoints() {
        const tasks = document.querySelectorAll(".task-item");
        const customTasks = document.querySelectorAll(".custom-task-item");

        let total = 0;
        let maxPossible = 0;

        tasks.forEach((task) => {
          const points = parseFloat(task.dataset.points);
          maxPossible += points;
          if (task.classList.contains("completed")) {
            total += points;
          }
        });

        customTasks.forEach((task) => {
          const points = parseFloat(
            task.querySelector(".task-points").textContent.replace("+", ""),
          );
          total += points;
        });

        document.getElementById("totalPoints").textContent = Math.round(total);
        document.getElementById("maxPoints").textContent =
          Math.round(maxPossible);

        const percentage = maxPossible > 0 ? (total / maxPossible) * 100 : 0;
        document.getElementById("progressFill").style.width = percentage + "%";
        document.getElementById("progressText").textContent =
          `${Math.round(total)}/${Math.round(maxPossible)} pts`;

        // NO loadWeeklyProgress() here!
      }
      async function loadWeeklyProgress() {
        try {
          const response = await fetch("/api/weekly_progress");
          const data = await response.json();
          document.getElementById("weekProgress").textContent =
            data.percentage + "%";
        } catch (error) {
          console.error("Error loading weekly progress:", error);
          document.getElementById("weekProgress").textContent = "0%";
        }
      }

      document.querySelectorAll(".task-item").forEach((item) => {
        item.addEventListener("click", async function () {
          const taskId = this.dataset.taskId;
          const date = "{{ today }}";
        
          // INSTANT visual feedback
          this.classList.toggle("completed");
          updatePoints();
        
          // Then save to server in background
          try {
            const response = await fetch("/api/toggle_task", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ task_id: taskId, date: date }),
            });
          
            if (!response.ok) {
              // If it failed, revert the change
              this.classList.toggle("completed");
              updatePoints();
              alert("Error saving task");
            }
          } catch (error) {
            console.error("Error toggling task:", error);
            // Revert on error
            this.classList.toggle("completed");
            updatePoints();
          }
        });
  });

      const moodSlider = document.getElementById("moodSlider");
      const moodValue = document.getElementById("moodValue");
      const moodDescription = document.getElementById("moodDescription");

      const moodDescriptions = {
        0: "Very Low",
        20: "Low",
        40: "Below Average",
        60: "Neutral",
        80: "Good",
        100: "Excellent",
      };

      moodSlider.addEventListener("input", function () {
        const value = this.value;
        moodValue.textContent = value;

        const closest = Object.keys(moodDescriptions).reduce((prev, curr) =>
          Math.abs(curr - value) < Math.abs(prev - value) ? curr : prev,
        );
        moodDescription.textContent = moodDescriptions[closest];
      });

      moodSlider.addEventListener("change", async function () {
        const moodScore = parseInt(this.value);
        const date = "{{ today }}";

        try {
          await fetch("/api/save_mood", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ mood_score: moodScore, date: date }),
          });
        } catch (error) {
          console.error("Error saving mood:", error);
        }
      });

      async function saveDailyReport() {
        const date = "{{ today }}";
        const workPerformance =
          parseInt(document.getElementById("workPerformance").value) || null;
        const accomplishment = document.getElementById("accomplishment").value;
        const challenge = document.getElementById("challenge").value;
        const randomThought = document.getElementById("randomThought").value;

        try {
          const response = await fetch("/api/save_daily_report", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              date: date,
              work_performance: workPerformance,
              accomplishment: accomplishment,
              challenge: challenge,
              random_thought: randomThought,
            }),
          });

          if (response.ok) {
            alert("Daily report saved successfully!");
          }
        } catch (error) {
          console.error("Error saving daily report:", error);
          alert("Error saving daily report");
        }
      }

      function openCustomTaskModal() {
        document.getElementById("customTaskModal").style.display = "block";
      }

      function closeCustomTaskModal() {
        document.getElementById("customTaskModal").style.display = "none";
        document.getElementById("customTaskName").value = "";
      }

      function selectPoints(points) {
        selectedPoints = points;
        document
          .querySelectorAll(".point-btn")
          .forEach((btn) => btn.classList.remove("selected"));
        event.target.classList.add("selected");
      }

      async function addCustomTask() {
        const name = document.getElementById("customTaskName").value.trim();
        if (!name) {
          alert("Please enter a task name");
          return;
        }

        const date = "{{ today }}";

        try {
          const response = await fetch("/api/add_custom_task", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              name: name,
              points: selectedPoints,
              date: date,
            }),
          });

          if (response.ok) {
            location.reload();
          }
        } catch (error) {
          console.error("Error adding custom task:", error);
        }
      }

      async function deleteCustomTask(taskId) {
        if (!confirm("Delete this custom task?")) return;

        try {
          const response = await fetch("/api/delete_custom_task", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ task_id: taskId }),
          });

          if (response.ok) {
            location.reload();
          }
        } catch (error) {
          console.error("Error deleting custom task:", error);
        }
      }

      async function exportData(period) {
        try {
          const response = await fetch(`/api/export?period=${period}`);
          const data = await response.json();
          const dataStr = JSON.stringify(data, null, 2);
          const dataBlob = new Blob([dataStr], { type: "application/json" });
          const url = URL.createObjectURL(dataBlob);
          const link = document.createElement("a");
          link.href = url;
          link.download = `dailybasisroute_${period}_${new Date().toISOString().split("T")[0]}.json`;
          link.click();
        } catch (error) {
          console.error("Error exporting data:", error);
        }
      }

      updatePoints(); // Calculate today's points
      loadWeeklyProgress(); // Load weekly average ONCE on page load
      moodSlider.dispatchEvent(new Event("input"));
    </script>
  </body>
</html>
